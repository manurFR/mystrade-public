{% extends "base.html" %}
{% load filters %}
{% load staticfiles %}
{% load widget_tweaks %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'jquery/jquery-ui-1.9.1.custom.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css-tooltips.css' %}" />
{% endblock %}

{% block scripts %}
    <script src="{% static 'jquery/jquery-1.8.2.min.js' %}"></script>
    <script src="{% static 'jquery/jquery-ui-1.9.1.custom.min.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="header">Game #{{ game }}
        {% if game.is_active %} (started {{ game.start_date|timesince }} ago, ending in {{ game.end_date|timeuntil }})
        {% elif game.is_closed %} (started {{ game.start_date|timesince }} ago, closed {{ game.closing_date|timesince }} ago)
        {% elif game.is_ended %} (started {{ game.start_date|timesince }} ago, ended {{ game.end_date|timesince }} ago)
        {% else %} (starting in {{ game.start_date|timeuntil }}, ending in {{ game.end_date|timeuntil }}){% endif %}
        <span class="floatright">&lt; <a href="{% url 'welcome' %}">Back</a></span>
    </div>

    <div class="reminder">
        This game's players:
        {% for player in players %}
            {% if player == user %}<div class="game-player">{{ player.name }} (you)</div>
            {% else %}<div class="game-player"><a href="{% url 'otherprofile' player.id %}">{{ player.name }}</a></div>{% endif %}
        {% endfor %}

        {% if user in game.players.all and game.is_active and not hand_submitted %}
            <br/>
            <div class="floatright"><a href="{% url 'submit_hand' game.id %}">&gt; Click here to submit your hand and finish now.</a></div>
            <br/>
        {% endif %}

        {% if user not in game.players.all %}               {# these nested ifs are important because a player in a game should never #}
            {% if user == game.master or user.is_staff %}   {# be given access to the control board even if (s)he is an admin         #}
                <br/>
                <div class="floatright"><a href="{% url 'control' game.id %}">&gt; Access to control board</a></div>
                <br/>
            {% endif %}
        {% endif %}
    </div>

    {% if user in game.players.all %}
    <div class="containerForColumns">
        <div class="leftOfTwoColumns">
            <strong>Hand</strong>
            <div class="css_table">
                <div class="css_table-row">
                    <div class="css_table-cell">
                        You own {{ rules|length }} rule card{{ rules|length|pluralize }}, and{% if hand_submitted %} you have submitted{% endif %}
                        {{ nb_commodities }} commodit{{ nb_commodities|pluralize:"y,ies" }}{% if nb_commodities == 0 %}.{% else %}:<br/>
                        {% for cih in commodities %}
                            {% for copy in cih.nb_cards|as_range %}
                                <span class="minicard" data-tip="{{ cih.commodity.name }}" style="background-color: {{ cih.commodity.color }}">&nbsp;</span>
                            {% endfor %}
                        {% endfor %}{% endif %}
                    </div>
                </div>
            </div>
            <a href="{% url 'hand' game.id %}">&gt; show more</a><br/>
        </div>

        <div class="rightOfTwoColumns">
            <strong>{% if pending_trades|length > 3 %}Last 3 pending trades{% else %}Pending trades{% endif %}</strong><br/>
            {% if pending_trades %}
                <div class="css_table">
                    {% for trade in pending_trades|slice:":3" %}
                        {% cycle 'even_color' 'odd_color' as color silent %}
                        <div class="css_table-row{% if trade.finalizer %} done{% endif %}{% if trade.status == 'CANCELLED' %} cancelled{% endif %}">
                            <div class="css_table-cell {{ color }}">
                                From <strong>{% include "common/name_or_you.html" with who=trade.initiator %}</strong>
                                to <strong>{% include "common/name_or_you.html" with who=trade.responder %}</strong>
                            </div>
                            <div class="css_table-cell {{ color }}">
                                {% if trade.status == 'INITIATED' %}
                                    offered {{ trade.creation_date|timesince }} ago
                                {% elif trade.status == 'CANCELLED' %}
                                    cancelled by {% include "common/name_or_you.html" with who=trade.finalizer %} {{ trade.closing_date|timesince }} ago
                                {% elif trade.status == 'REPLIED' %}
                                    response submitted by {% include "common/name_or_you.html" with who=trade.responder %}
                                {% elif trade.status == 'ACCEPTED' %}
                                    done {{ trade.closing_date|timesince }} ago
                                {% elif trade.status == 'DECLINED' %}
                                    declined by {% include "common/name_or_you.html" with who=trade.finalizer %} {{ trade.closing_date|timesince }} ago
                                {% endif %}
                            </div>
                            <div class="css_table-cell {{ color }}">
                                {% if game.is_active and trade.status == 'INITIATED' and user == trade.responder %}
                                    <a href="{% url 'show_trade' game.id trade.id %}"><span class="new">Reply</span></a>
                                {% elif game.is_active and trade.status == 'REPLIED' and user == trade.initiator %}
                                    <a href="{% url 'show_trade' game.id trade.id %}"><span class="new">Decide</span></a>
                                {% else %}
                                    <a href="{% url 'show_trade' game.id trade.id %}">Show</a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="helptext">No pending trades.</div>
            {% endif %}
            <a href="{% url 'trades' game.id %}">&gt; show more{% if game.is_active and not hand_submitted %} (or create a new trade proposal){% endif %}</a>
        </div>
    </div>
    {% endif %}

    <br/>
    <div class="header">Message Wall</div>

    <table style="margin: auto">
        <tr>
            <td><strong>{{ message_form.message.label_tag }}:</strong>
                <span class="helptext">(<a href="https://github.com/fletcher/MultiMarkdown/blob/master/Documentation/Markdown%20Syntax.md">Markdown</a> allowed)</span>
                <div class="lowerhelptext floatright"><span id="charactersLeft">{{ maxMessageLength }}</span> characters left</div>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <form action="{% url 'game' game.id %}" method="POST">{% csrf_token %}
                <td style="width: 600px;">{{ message_form.message|attr:"rows:3" }}&nbsp;
                    <span class="errors">{{ message_form.message.errors.as_text }}</span>
                </td>
                <td style="vertical-align: top"><input type="submit" class="post-button" value="Post"/></td>
            </form>
        </tr>

        {% if messages.has_previous %}
            <tr><td><a href="?page={{ messages.previous_page_number }}">&lt; more recent messages</a></td><td>&nbsp;</td></tr>
            <tr class="small-height"><td>&nbsp;</td><td>&nbsp;</td></tr>
        {% endif %}
        {% for msg in messages %}
        <tr class="message" id={{ msg.id }}>
            <td>
                <div class="message_sender">{% include "common/name_or_you.html" with who=msg.sender %}
                    {% if msg.sender == game.master %} (<strong>game master</strong>) {% endif %}
                    said:
                    {% if msg.sender == user and msg.in_grace_period %}
                        <div class="floatright">
                            <form method='POST' action="{% url 'delete_message' game.id msg.id %}" class="form-button">{% csrf_token %}
                                <span data-tip="Delete"><input type="submit" class="delete" value=""/></span>
                            </form>
                        </div>
                    {% endif %}
                </div>
                {% if msg.sender == game.master %}
                <div class="message_content admin">
                    <img src="{% static 'tie.png' %}" alt=""/>
                    <p>{{ msg.content|safe|linebreaksbr }}</p>
                </div>
                {% else %}
                <div class="message_content">{{ msg.content|safe|linebreaksbr }}</div>
                {% endif %}
                <div class="helptext floatright message_date">{{ msg.posting_date|timesince }} ago</div>
            </td>
            <td>&nbsp;</td>
        </tr>
        {% endfor %}
        {% if messages.has_next %}
            <tr><td><span class="floatright"><a href="?page={{ messages.next_page_number }}">show more &gt;</a></span></td><td>&nbsp;</td></tr>
        {% endif %}
    </table>


    <script>
        $(function() {
            $('input.post-button').button();
        });

        var maxlength = {{ maxMessageLength }};
        $('#id_message').attr('maxlength', maxlength); // direct support for HTML5-enabled browsers

        $('#id_message').on('keyup', function() {
            var vallength = $(this).val().length;
            $("#charactersLeft").html(maxlength - vallength);

            // Trim the field if it has content over the maxlength, for non-HTML5 browsers
            if (vallength > maxlength) {
                $(this).val($(this).val().slice(0, maxlength));
            }
        });
    </script>

{% endblock %}