{% load widget_tweaks %}

<div class="show_previous">{% if dateprevious %}<a>&lt; show previous events</a>{% endif %}</div>
{% for msg in messages %}
    <div class="event">
        <div class="event_time">{{ msg.posting_date|time }}</div>
        <div class="event_text">
            {% include "common/name_or_you.html" with who=msg.sender %}
            {% if msg.sender == game.master %} (<strong>game master</strong>) {% endif %}
            {% if msg.sender == user %} have {% else %} has {% endif %}
            posted a message:
        </div>
        <div class="message_content{% if msg.sender == game.master %} admin{% endif %}">{{ msg.content|safe|linebreaksbr }}</div>
    </div>
{% endfor %}
<div class="show_more">{% if datenext %}<a>show more events &gt;</a>{% endif %}</div>

<h3>Post a public message</h3>
<div>
    <span class="helptext">(<a href="https://github.com/fletcher/MultiMarkdown/blob/master/Documentation/Markdown%20Syntax.md">Markdown</a> allowed)</span>
    <span class="helptext chars_left"><span id="charactersLeft">{{ maxMessageLength }}</span> characters left</span>
</div>
<form id="post_message">{% csrf_token %}
    {{ message_form.message|attr:"rows:3" }}&nbsp;
        <span class="errors" id="error_message"/>
    <div class="show_more"><input type="submit" id="button_post_message" value="Post"/></div>
</form>

<script>
    $(function() {
        $('input#button_post_message').button();
    });

    var maxlength = {{ maxMessageLength }};
    $('#id_message').attr('maxlength', maxlength); // direct support for HTML5-enabled browsers

    $('#id_message').on('keyup', function() {
        var vallength = $(this).val().length;
        $("#charactersLeft").html(maxlength - vallength);

        // Trim the field if it has content over the maxlength, for non-HTML5 browsers
        if (vallength > maxlength) {
            $(this).val($(this).val().slice(0, maxlength));
        }
    });

    $("#post_message").on("submit", function() {
        $.post("{% url 'post_message' game.id %}", $(this).serialize())
            .fail(function(jqXHR) {
                var error;
                if (jqXHR.status == 422) error = jqXHR.responseText;
                else error = "Error sending data. Please try again.";
                $('#error_message').text(error);
            })
            .done(function() {
                // refresh from the start of the list of events
                $("li.tab-recently a").attr("href", "{% url 'events' game.id %}");
                $('#zone_tabs').tabs("load", 0);
            });
        return false;
    });

    $(".show_previous a").on("click", function() {
        $("li.tab-recently a").attr("href", "{% url 'events' game.id %}?dateprevious={{ dateprevious }}");
        $('#zone_tabs').tabs("load", 0);
    });
    $(".show_more a").on("click", function() {
        $("li.tab-recently a").attr("href", "{% url 'events' game.id %}?datenext={{ datenext }}");
        $('#zone_tabs').tabs("load", 0);
    });
</script>