{% extends "base.html" %}
{% load staticfiles %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'jquery/jquery-ui-1.10.3.custom.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css-tooltips.css' %}" />
{% endblock %}

{% block scripts %}
    <script src="{% static 'jquery/jquery-1.8.2.min.js' %}"></script>
    <script src="{% static 'jquery/jquery-ui-1.10.3.custom.min.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="header">Trade for game #{{ game }} (ending in {{ game.end_date|timeuntil }})
        <span class="floatright">&lt;
            {% if user in game.players.all %}<a href="{% url 'game' game.id %}">Back</a>
            {% else %}<a href="{% url 'control' game.id %}">Back</a>{% endif %}
        </span></div>
    {% if not trade %}
        {# Trade creation #}
        <form action="{% url 'create_trade' game.id %}" method="post">{% csrf_token %}
        <div>Set up a new trade proposal to : {{ trade_form.responder }}&nbsp;<span class="errors">{{ trade_form.responder.errors.as_text }}</span></div>
        {% include "trade/create_offer.html" with submit="Propose this trade" %}
        </form>
    {% else %}
        <div>Trade proposed by {% include "common/name_or_you.html" with who=trade.initiator %} to {% include "common/name_or_you.html" with who=trade.responder %} &mdash;
        Status :
        {% if trade.status == 'INITIATED' %}
            {% if game.is_active %}waiting for response by {% include "common/name_or_you.html" with who=trade.responder %}
            {% else %}<strong>This game has ended. This trade proposal can not be advanced any further.</strong>{% endif %}
        {% elif trade.status == 'CANCELLED' %}cancelled by {% include "common/name_or_you.html" with who=trade.finalizer %} {{ trade.closing_date|timesince }} ago
        {% elif trade.status == 'REPLIED' %}
            {% if game.is_active %}waiting for definitive agreement by {% include "common/name_or_you.html" with who=trade.initiator %}
            {% else %}<strong>This game has ended. This trade proposal can not be advanced any further.</strong>{% endif %}
        {% elif trade.status == 'ACCEPTED' %}accepted and performed
        {% elif trade.status == 'DECLINED' %}declined by {% include "common/name_or_you.html" with who=trade.finalizer %} {{ trade.closing_date|timesince }} ago
        {% endif %}
        </div>

        {# First, display the initiator's offer. #}
        <h3>Offered by {% include "common/name_or_you.html" with who=trade.initiator %}:</h3>
        {% include "trade/display_offer.html" with offer=trade.initiator_offer giver=trade.initiator %}

        {% if trade.status == 'INITIATED' and game.is_active %}
            {% if user == trade.initiator  %}
                <div class="floatright">
                    <form action="{% url 'cancel_trade' trade.game.id trade.id %}" method="post">{% csrf_token %}
                        <input type="submit" value="Cancel this trade"/>
                    </form>
                </div>
            {% elif user == trade.responder %}
                <div class="floatright">
                    <button type="button" id="reply">Reply with your offer</button> &nbsp;&nbsp;
                    <button type="button" id="decline">Decline</button>
                </div>
                <div id="offer"><h3>Your offer:</h3>
                    <form action="{% url 'reply_trade' game.id trade.id %}" method="post">{% csrf_token %}
                    {% include "trade/create_offer.html" with submit="Reply with this offer" %}
                    </form>
                </div>
                {% include "trade/decline_trade.html" %}
            {% endif %}
        {% elif trade.responder_offer %}
            {# Display the responder's offer. #}
            <h3>Offered by {% include "common/name_or_you.html" with who=trade.responder %}:</h3>
            {% include "trade/display_offer.html" with offer=trade.responder_offer giver=trade.responder %}

            {% if trade.status == 'REPLIED' and game.is_active %}
                {% if user == trade.responder %}
                    <div class="floatright">
                        <form action="{% url 'cancel_trade' trade.game.id trade.id %}" method="post">{% csrf_token %}
                            <input type="submit" value="Cancel this trade"/>
                        </form>
                    </div>
                {% elif user == trade.initiator %}
                    <div class="floatright">
                        <form action="{% url 'accept_trade' trade.game.id trade.id %}" method="post">{% csrf_token %}
                            <input type="submit" value="Accept this trade" id="accept"/> &nbsp;&nbsp;
                            <button type="button" id="decline">Decline</button>
                        </form>
                    </div>
                    {% include "trade/decline_trade.html" %}
                {% endif %}
            {% endif %}
        {% endif %}
        <br/>
        {% if trade.status == 'DECLINED' and trade.decline_reason %}
        <div class="trade_reason">
            <h3>{% include "common/name_or_you.html" with who=trade.finalizer %} gave the following reason to decline:</h3>
            {{  trade.decline_reason }}
        </div>
        {% endif %}
        <br/><br/><br/>
    {% endif %}

    <script>
        $(function() {
            $('input[type=submit], button').button();
        {% if errors %}
            $('#reply').hide();
            $('#decline').hide();
        {% else %}
            $('#offer').hide();
            $('#reply').on("click", function() {
                $('#offer').show("blind");
                $('#reply').hide("blind");
                $('#decline').hide("blind")
            })
        {% endif %}
        });
    </script>
{% endblock content %}