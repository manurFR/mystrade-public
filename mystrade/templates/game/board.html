{% extends "base.html" %}

{% load filters %}
{% load staticfiles %}
{% load widget_tweaks %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'jquery/jquery-ui-1.9.1.custom.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.game.board.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css-tooltips.css' %}" />
{% endblock %}

{% block scripts %}
    <script src="{% static 'jquery/jquery-1.8.2.js' %}"></script>
    <script src="{% static 'jquery/jquery-ui-1.9.1.custom.js' %}"></script>
{% endblock %}

{% block content %}
    <div id="zone_game_header">
        <div id="zone_game_label">
            <div id="game_label">Game #{{ game.id }}</div>
            <div id="game_delay" class="helptext">
                {% if game.is_active %}ending in {{ game.end_date|timeuntil }}
                {% elif game.is_closed %}closed {{ game.closing_date|timesince }} ago
                {% elif game.has_ended %}ended {{ game.end_date|timesince }} ago
                {% else %}starting in {{ game.start_date|timeuntil }}{% endif %}
            </div>
        </div>

        <div id="zone_player_list">
            <div>
                {% for player in players %}
                    {% if player == user %}<div class="game-player">{{ player.name }} (you)</div>
                    {% else %}<div class="game-player"><a href="{% url 'otherprofile' player.id %}">{{ player.name }}</a></div>{% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="zone_game_main">
        <div id="zone_hand">
            <div id="zone_links">&nbsp;</div>

            <div id="zone_commodities">
                <h3>{% if hand_submitted %}Submitted Commodities
                    {% else %}Commodities <span class="helptext">Click to create a new trade proposal</span>{% endif %}</h3>
                {% for cih in commodities %}
                    {% for copy in cih.nb_cards|as_range %}
                        <span class="commodity_card" data-tip="{{ cih.commodity.name }}" style="background-color: {{ cih.commodity.color }}">&nbsp;</span>
                    {% endfor %}
                {% endfor %}
                {% for cih in commodities_not_submitted %}
                    {% for copy in cih.nb_cards|as_range %}
                        <span class="commodity_card not_submitted" data-tip="{{ cih.commodity.name }} -- not submitted" style="background-color: {{ cih.commodity.color }}">&nbsp;</span>
                    {% endfor %}
                {% endfor %}
            </div>

            <div id="zone_rules">
                <h3>Rules{% if not hand_submitted %} <span class="helptext">Click to create a new trade proposal</span>{% endif %}</h3>

                <div id="zone_rulecards">
                    {% for card in rulecards %}
                    <div class="rulecard">
                        <div class="rulecard_name">{{ card.rulecard.public_name }}</div>
                        <div class="rulecard_desc">{{ card.rulecard.description }}</div>
                    </div>
                    {% endfor %}
                    {% for card in former_rulecards %}
                    <div class="rulecard former">
                        <div class="previously_owned helptext">(previously owned)</div>
                        <div class="rulecard_name">{{ card.rulecard.public_name }}</div>
                        <div class="rulecard_desc">{{ card.rulecard.description }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if free_informations %}
            <div id="zone_free_informations">
                <h3>Free informations obtained during this game</h3>
                {% for offer in free_informations %}
                    <fieldset class="free_information">
                        <legend>from <strong>{{ offer.offerer }}</strong>, {{ offer.date|timesince }} ago</legend>
                        {{ offer.free_information }}<br/>
                    </fieldset>
                {% endfor %}
            </div>
            {% endif %}

        </div>

        <div id="zone_tabs">
            <ul>
                <li><a href="#tab-event">Recently</a></li>
                <li><a href="#tab-trade">New Trade</a></li>
            </ul>
            <div id="tab-event">
                <div id="zone_events"></div>

                <div id="zone_post_message">
                    <h3>Post a public message</h3>
                    <div>
                        <span class="helptext">(<a href="https://github.com/fletcher/MultiMarkdown/blob/master/Documentation/Markdown%20Syntax.md">Markdown</a> allowed)</span>
                        <span class="helptext chars_left"><span id="charactersLeft">{{ maxMessageLength }}</span> characters left</span>
                    </div>
                    <form id="post_message">{% csrf_token %}
                        {{ message_form.message|attr:"rows:3" }}&nbsp;
                        <span class="errors" id="error_message"></span>
                        <div class="submit"><input type="submit" id="button_post_message" value="Post"/></div>
                    </form>
                </div>
            </div>
            <div id="tab-trade">
                <div id="zone_trade">
                    {% include "trade/trade.html" %}
                </div>
            </div>
        </div>
   </div>

    <script>
        var color_list = ["blue", "red", "green", "magenta", "gray", "brown"];
        var idx = {{ game.id }} % color_list.length;

        function refreshEvents(datenext, dateprevious) {
            var url = "{% url 'events' game.id %}";
            if (datenext) url += "?datenext=" + datenext;
            if (dateprevious) url += "?dateprevious=" + dateprevious;
            $.get(url)
                .fail(function() {
                    $("#zone_events").text("Error loading recent events. Please try again.");
                })
                .done(function(data) {
                    $("#zone_events").html(data);
                });
        }

        $(function() {
            $('#zone_game_label *').css('color', color_list[idx]);
            $("#zone_tabs").tabs({heightStyle: "content"});
            $("input#button_post_message").button();

            refreshEvents();
        });

        var maxlength = {{ maxMessageLength }};
        $('#id_message').attr('maxlength', maxlength); // direct support for HTML5-enabled browsers

        $('#id_message').on('keyup', function() {
            var vallength = $(this).val().length;
            $("#charactersLeft").html(maxlength - vallength);

            // Trim the field if it has content over the maxlength, for non-HTML5 browsers
            if (vallength > maxlength) {
                $(this).val($(this).val().slice(0, maxlength));
            }
        });

        $("#post_message").on("submit", function() {
            $.post("{% url 'post_message' game.id %}", $(this).serialize())
                .fail(function(jqXHR) {
                    var error;
                    if (jqXHR.status == 422) error = jqXHR.responseText;
                    else error = "Error sending data. Please try again.";
                    $('#error_message').text(error);
                })
                .done(function() {
                    refreshEvents();
                    $("#id_message").val("").focus(); // clear the textarea
                });
            return false;
        });

        function deleteMessage(trash_icon) {
            $(trash_icon).hide(); // to prevent multi-clicks
            $.post("{% url 'delete_message' game.id %}", $(trash_icon).parent("form").serialize())
                .fail(function(jqXHR) {
                    $(trash_icon).show(); // show it again to enable re-trying
                    alert("Error deleting message. Please try again.");
                })
                .done(function() {
                    refreshEvents();
                });
        }
    </script>
{% endblock %}
